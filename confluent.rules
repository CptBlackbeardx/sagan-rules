# Sagan confluent.rules
# Copyright (c) 2009-2021. Quadrant Information Security <www.quadrantsec.com>
# All rights reserved.
#
# Please submit any custom rules or ideas to sagan-submit@quadrantsec.com or the sagan-sigs mailing list
#
#*************************************************************
#  Redistribution and use in source and binary forms, with or without modification, are permitted provided that the
#  following conditions are met:
#
#  * Redistributions of source code must retain the above copyright notice, this list of conditions and the following
#    disclaimer.
#  * Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the
#    following disclaimer in the documentation and/or other materials provided with the distribution.
#  * Neither the name of the nor the names of its contributors may be used to endorse or promote products derived
#    from this software without specific prior written permission.
#
#  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY EXPRESS OR IMPLIED WARRANTIES,
#  INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
#  DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
#  SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
#  SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
#  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE
#  USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#
#*************************************************************
#

# These sigantures are by Joseph Suain @ Quandrant Information Security.  They requre that JSON be 
# enabled within the Sagan YAML.

alert any $HOME_NET any -> $EXTERNAL_NET any (msg: "[CONFLUENT] Authorization to create Kafka Cluster"; json_content: ".data.methodName", "mds.Authorize"; json_content: ".data.authorizationInfo.granted", "true"; json_content: ".data.authorizationInfo.operation", "CreateCloudCluster"; classtype: successful-user; reference: url,docs.confluent.io/cloud/current/access-management/audit-logging/cloud-audit-log-concepts.html; reference: url,wiki.quadrantsec.com/bin/view/Main/5005235; sid:5005235; rev:1;)

alert any $HOME_NET any -> $EXTERNAL_NET any (msg: "[CONFLUENT] Kafka Successful Authentication"; json_content: ".data.methodName", "kafka.Authentication"; json_content: ".data.result.status", "SUCCESS"; classtype: successful-user; reference: url,docs.confluent.io/cloud/current/access-management/audit-logging/cloud-audit-log-concepts.html; reference: url,wiki.quadrantsec.com/bin/view/Main/5005236; sid:5005236; rev:1;)

alert any $HOME_NET any -> $EXTERNAL_NET any (msg: "[CONFLUENT] Kafka Successful Authentication using API Key"; json_content: ".data.methodName", "kafka.Authentication"; json_content: ".data.result.status", "SUCCESS"; json_content: ".data.authenticationInfo.metadata.mechanism", "SASL_SSL/OAUTHBEARER"; classtype: successful-user; reference: url,docs.confluent.io/cloud/current/access-management/audit-logging/cloud-audit-log-concepts.html; reference: url,wiki.quadrantsec.com/bin/view/Main/5005237; sid:5005237; rev:1;)

alert any $HOME_NET any -> $EXTERNAL_NET any (msg: "[CONFLUENT] Kafka Successful Authentication using Interactive Token"; json_content: ".data.methodName", "kafka.Authentication"; json_content: ".data.result.status", "SUCCESS"; json_content: ".data.authenticationInfo.metadata.mechanism", "SASL_SSL/PLAIN"; classtype: successful-user; reference: url,docs.confluent.io/cloud/current/access-management/audit-logging/cloud-audit-log-concepts.html; reference: url,wiki.quadrantsec.com/bin/view/Main/5005238; sid:5005238; rev:1;)

alert any $HOME_NET any -> $EXTERNAL_NET any (msg: "[CONFLUENT] Kafka Failed Authentication"; json_content: ".data.methodName", "kafka.Authentication"; json_content: ".data.result.status", "UNAUTHENTICATED"; classtype: unsuccessful-user; reference: url,docs.confluent.io/cloud/current/access-management/audit-logging/cloud-audit-log-concepts.html; reference: url,wiki.quadrantsec.com/bin/view/Main/5005239; sid:5005239; rev:1;)

alert any $HOME_NET any -> $EXTERNAL_NET any (msg: "[CONFLUENT] Kafka Failed Authentication using Interactive Token"; json_content: ".data.methodName", "kafka.Authentication"; json_content: ".data.result.status", "UNAUTHENTICATED"; json_content: ".data.authenticationInfo.metadata.mechanism", "SASL_SSL/PLAIN"; classtype: unsuccessful-user; reference: url,docs.confluent.io/cloud/current/access-management/audit-logging/cloud-audit-log-concepts.html; reference: url,wiki.quadrantsec.com/bin/view/Main/5005240; sid:5005240; rev:1;)

alert any $HOME_NET any -> $EXTERNAL_NET any (msg: "[CONFLUENT] Kafka Failed Authentication using API Key"; json_content: ".data.methodName", "kafka.Authentication"; json_content: ".data.result.status", "UNAUTHENTICATED"; json_content: ".data.authenticationInfo.metadata.mechanism", "SASL_SSL/OAUTHBEARER"; classtype: unsuccessful-user; reference: url,docs.confluent.io/cloud/current/access-management/audit-logging/cloud-audit-log-concepts.html; reference: url,wiki.quadrantsec.com/bin/view/Main/5005241; sid:5005241; rev:1;)

alert any $HOME_NET any -> $EXTERNAL_NET any (msg: "[CONFLUENT] Login failure- Brute Force [5/5]"; json_content: ".data.methodName", "kafka.Authentication"; json_content: ".data.result.status", "UNAUTHENTICATED"; after: track by_src, count 5, seconds 300; threshold: type suppress, track by_src, count 1, seconds 86400; xbits: set,brute_force,track ip_src, expire 21600; classtype: unsuccessful-user; reference: url,docs.confluent.io/cloud/current/access-management/audit-logging/cloud-audit-log-concepts.html; reference: url,wiki.quadrantsec.com/bin/view/Main/5005242; sid:5005242; rev:1;)

alert any $HOME_NET any -> $EXTERNAL_NET any (msg: "[CONFLUENT] Kafka Configuration Altered/Updated"; json_content: ".data.methodName", "kafka.AlterConfigs"; json_content: ".data.authorizationInfo.granted", "true"; classtype: configuration-change; reference: url,docs.confluent.io/cloud/current/access-management/audit-logging/cloud-audit-log-concepts.html; reference: url,wiki.quadrantsec.com/bin/view/Main/5005243; sid:5005243; rev:1;)

alert any $HOME_NET any -> $EXTERNAL_NET any (msg: "[CONFLUENT] Kafka Mirror Topic Properties Altered/Updated"; json_content: ".data.methodName", "kafka.AlterMirrors"; json_content: ".data.authorizationInfo.granted", "true"; classtype: configuration-change; reference: url,docs.confluent.io/cloud/current/access-management/audit-logging/cloud-audit-log-concepts.html; reference: url,wiki.quadrantsec.com/bin/view/Main/5005244; sid:5005244; rev:1;)

alert any $HOME_NET any -> $EXTERNAL_NET any (msg: "[CONFLUENT] Kafka Broker ACL Created"; json_content: ".data.methodName", "kafka.CreateAcls"; json_content: ".data.authorizationInfo.granted", "true"; classtype: configuration-change; reference: url,docs.confluent.io/cloud/current/access-management/audit-logging/cloud-audit-log-concepts.html; reference: url,wiki.quadrantsec.com/bin/view/Main/5005245; sid:5005245; rev:1;)

alert any $HOME_NET any -> $EXTERNAL_NET any (msg: "[CONFLUENT] Kafka Cluster Link Created"; json_content: ".data.methodName", "kafka.CreateClusterLinks"; json_content: ".data.authorizationInfo.granted", "true"; classtype: configuration-change; reference: url,docs.confluent.io/cloud/current/access-management/audit-logging/cloud-audit-log-concepts.html; reference: url,wiki.quadrantsec.com/bin/view/Main/5005246; sid:5005246; rev:1;)

alert any $HOME_NET any -> $EXTERNAL_NET any (msg: "[CONFLUENT] Kafka Partition Created"; json_content: ".data.methodName", "kafka.CreatePartitions"; json_content: ".data.authorizationInfo.granted", "true"; classtype: configuration-change; reference: url,docs.confluent.io/cloud/current/access-management/audit-logging/cloud-audit-log-concepts.html; reference: url,wiki.quadrantsec.com/bin/view/Main/5005247; sid:5005247; rev:1;)

alert any $HOME_NET any -> $EXTERNAL_NET any (msg: "[CONFLUENT] Kafka Topic Created"; json_content: ".data.methodName", "kafka.CreateTopics"; json_content: ".data.authorizationInfo.granted", "true"; json_content: ".data.authorizationInfo.operation", "Create"; classtype: configuration-change; reference: url,docs.confluent.io/cloud/current/access-management/audit-logging/cloud-audit-log-concepts.html; reference: url,wiki.quadrantsec.com/bin/view/Main/5005248; sid:5005248; rev:1;)

alert any $HOME_NET any -> $EXTERNAL_NET any (msg: "[CONFLUENT] Specific Kafka Topic Created"; json_content: ".data.methodName", "kafka.CreateTopics"; json_content: ".data.authorizationInfo.granted", "true"; json_content: ".data.authorizationInfo.operation", "DescribeConfigs"; classtype: configuration-change; reference: url,docs.confluent.io/cloud/current/access-management/audit-logging/cloud-audit-log-concepts.html; reference: url,wiki.quadrantsec.com/bin/view/Main/5005249; sid:5005249; rev:1;)

alert any $HOME_NET any -> $EXTERNAL_NET any (msg: "[CONFLUENT] Specific Kafka Topic Creation Not Allowed"; json_content: ".data.methodName", "kafka.CreateTopics"; json_content: ".data.authorizationInfo.granted", "false"; json_content: ".data.authorizationInfo.operation", "Create"; json_content: ".data.authorizationInfo.superUserAuthorization", "false"; classtype: unsuccessful-user; reference: url,docs.confluent.io/cloud/current/access-management/audit-logging/cloud-audit-log-concepts.html; reference: url,wiki.quadrantsec.com/bin/view/Main/5005250; sid:5005250; rev:1;)

alert any $HOME_NET any -> $EXTERNAL_NET any (msg: "[CONFLUENT] Kafka Broker ACL Deleted"; json_content: ".data.methodName", "kafka.DeleteAcls"; json_content: ".data.authorizationInfo.granted", "true"; classtype: configuration-change; reference: url,docs.confluent.io/cloud/current/access-management/audit-logging/cloud-audit-log-concepts.html; reference: url,wiki.quadrantsec.com/bin/view/Main/5005251; sid:5005251; rev:1;)

alert any $HOME_NET any -> $EXTERNAL_NET any (msg: "[CONFLUENT] Kafka Cluster Link Deleted"; json_content: ".data.methodName", "kafka.DeleteClusterLinks"; json_content: ".data.authorizationInfo.granted", "true"; classtype: configuration-change; reference: url,docs.confluent.io/cloud/current/access-management/audit-logging/cloud-audit-log-concepts.html; reference: url,wiki.quadrantsec.com/bin/view/Main/5005252; sid:5005252; rev:1;)

alert any $HOME_NET any -> $EXTERNAL_NET any (msg: "[CONFLUENT] Kafka Group Deleted"; json_content: ".data.methodName", "kafka.DeleteGroups"; json_content: ".data.authorizationInfo.granted", "true"; classtype: configuration-change; reference: url,docs.confluent.io/cloud/current/access-management/audit-logging/cloud-audit-log-concepts.html; reference: url,wiki.quadrantsec.com/bin/view/Main/5005253; sid:5005253; rev:1;)

alert any $HOME_NET any -> $EXTERNAL_NET any (msg: "[CONFLUENT] Kafka Record Deleted"; json_content: ".data.methodName", "kafka.DeleteRecords"; json_content: ".data.authorizationInfo.granted", "true"; classtype: configuration-change; reference: url,docs.confluent.io/cloud/current/access-management/audit-logging/cloud-audit-log-concepts.html;  reference: url,wiki.quadrantsec.com/bin/view/Main/5005254; sid:5005254; rev:1;)

alert any $HOME_NET any -> $EXTERNAL_NET any (msg: "[CONFLUENT] Kafka Topic Deleted"; json_content: ".data.methodName", "kafka.DeleteTopics"; json_content: ".data.authorizationInfo.granted", "true"; classtype: configuration-change; reference: url,docs.confluent.io/cloud/current/access-management/audit-logging/cloud-audit-log-concepts.html; reference: url,wiki.quadrantsec.com/bin/view/Main/5005255;  sid:5005255; rev:1;)

alert any $HOME_NET any -> $EXTERNAL_NET any (msg: "[CONFLUENT] Kafka Broker Dynamic Configuration Altered"; json_content: ".data.methodName", "kafka.IncrementalAlterConfigs"; json_content: ".data.authorizationInfo.granted", "true"; classtype: configuration-change; reference: url,docs.confluent.io/cloud/current/access-management/audit-logging/cloud-audit-log-concepts.html; reference: url,wiki.quadrantsec.com/bin/view/Main/5005256; sid:5005256; rev:1;)

alert any $HOME_NET any -> $EXTERNAL_NET any (msg: "[CONFLUENT] Kafka Broker Dynamic Configuration Altered (SuperUser)"; json_content: ".data.methodName", "kafka.IncrementalAlterConfigs"; json_content: ".data.authorizationInfo.granted", "true"; json_content: ".data.authorizationInfo.superUserAuthorization", "true"; classtype: configuration-change; reference: url,docs.confluent.io/cloud/current/access-management/audit-logging/cloud-audit-log-concepts.html; reference: url,wiki.quadrantsec.com/bin/view/Main/5005257; sid:5005257; rev:1;)

alert any $HOME_NET any -> $EXTERNAL_NET any (msg: "[CONFLUENT] Kafka Broker Dynamic Configuration Altered (ACL)"; json_content: ".data.methodName", "kafka.IncrementalAlterConfigs"; json_content: ".data.authorizationInfo.granted", "true"; json_content: ".data.authorizationInfo.superUserAuthorization", "false"; json_content: ".data.authorizationInfo.aclAuthorization.permissionType", "ALLOW"; classtype: configuration-change; reference: url,docs.confluent.io/cloud/current/access-management/audit-logging/cloud-audit-log-concepts.html; reference: url,wiki.quadrantsec.com/bin/view/Main/5005258; sid:5005258; rev:1;)

alert any $HOME_NET any -> $EXTERNAL_NET any (msg: "[CONFLUENT] Kafka Committed Offset for Partition in Consumer Group Deleted"; json_content: ".data.methodName", "kafka.OffsetDelete"; json_content: ".data.authorizationInfo.granted", "true"; classtype: configuration-change; reference: url,docs.confluent.io/cloud/current/access-management/audit-logging/cloud-audit-log-concepts.html; reference: url,wiki.quadrantsec.com/bin/view/Main/5005259;  sid:5005259; rev:1;)
