# Sagan windows-powershell.rules
# Copyright (c) 2009-2022. Quadrant Information Security <www.quadrantsec.com>
# All rights reserved.
#
# Please submit any custom rules or ideas to sagan-submit@quadrantsec.com or the sagan-sigs mailing list
#
#*************************************************************
#  Redistribution and use in source and binary forms, with or without modification, are permitted provided that the
#  following conditions are met:
#
#  * Redistributions of source code must retain the above copyright notice, this list of conditions and the following
#    disclaimer.
#  * Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the
#    following disclaimer in the documentation and/or other materials provided with the distribution.
#  * Neither the name of the nor the names of its contributors may be used to endorse or promote products derived
#    from this software without specific prior written permission.
#
#  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY EXPRESS OR IMPLIED WARRANTIES,
#  INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
#  DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
#  SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
#  SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
#  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE
#  USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#
#*************************************************************

# Make sure you have powershell logging enabled! 
# 2021/04/19 - Steven Drenning (sdrenning _AT_ quadrantsec.com)

alert any $HOME_NET any -> $EXTERNAL_NET any (msg:"[WINDOWS-POWERSHELL] Powershell History Cleared Detected [1/4]"; program: *PowerShell*; content: "HistorySave"; content: "del|20 28|Get|2D|PSReadlineOption|29 2E|HistorySavePath"; classtype: suspicious-command; reference: url,github.com/SigmaHQ/sigma/blob/master/rules/powershell; reference: url,wiki.quadrantsec.com/bin/view/Main/5005747; sid:5005747; rev:1;)
alert any $HOME_NET any -> $EXTERNAL_NET any (msg:"[WINDOWS-POWERSHELL] Powershell History Cleared Detected [2/4]"; program: *PowerShell*; content: "HistorySave"; content: "Set|2D|PSReadlineOption |2D|HistorySaveStyle SaveNothing"; classtype: suspicious-command; reference: url,github.com/SigmaHQ/sigma/blob/master/rules/powershell; reference: url,wiki.quadrantsec.com/bin/view/Main/5005748; sid:5005748; rev:1;)
alert any $HOME_NET any -> $EXTERNAL_NET any (msg:"[WINDOWS-POWERSHELL] Powershell History Cleared Detected [3/4]"; program: *PowerShell*; content: "HistorySave";  content: "Remove|2D|Item |28|Get|2D|PSReadlineOption|29 2E|HistorySavePath";classtype: suspicious-command; reference: url,github.com/SigmaHQ/sigma/blob/master/rules/powershell; reference: url,wiki.quadrantsec.com/bin/view/Main/5005749; sid:5005749; rev:1;)
alert any $HOME_NET any -> $EXTERNAL_NET any (msg:"[WINDOWS-POWERSHELL] Powershell History Cleared Detected [4/4]"; program: *PowerShell*; content: "HistorySave";  content: "rm |28|Get|2D|PSReadlineOption|29 2E|HistorySavePath";classtype: suspicious-command; reference: url,github.com/SigmaHQ/sigma/blob/master/rules/powershell; reference: url,wiki.quadrantsec.com/bin/view/Main/5005750; sid:5005750; rev:1;)
#--
alert any $HOME_NET any -> $EXTERNAL_NET any (msg:"[WINDOWS-POWERSHELL] Powershell created local user [1/3]"; event_id: 4104; program: *PowerShell*; content: "New|2D|LocalUser |2D|Name"; content: "|2D|NoPassword"; distance: 0; classtype: suspicious-command; reference: url,github.com/SigmaHQ/sigma/blob/master/rules/powershell; reference: url,wiki.quadrantsec.com/bin/view/Main/5005751; sid:5005751; rev:1;)
alert any $HOME_NET any -> $EXTERNAL_NET any (msg:"[WINDOWS-POWERSHELL] Powershell created local user [2/3]"; event_id: 4104; program: *PowerShell*; content: "net user |2F|add"; classtype: suspicious-command; reference: url,github.com/SigmaHQ/sigma/blob/master/rules/powershell; reference: url,wiki.quadrantsec.com/bin/view/Main/5005752; sid:5005752; rev:1;)
alert any $HOME_NET any -> $EXTERNAL_NET any (msg:"[WINDOWS-POWERSHELL] Powershell created local user [3/3]"; event_id: 4104; program: *PowerShell*; content: "net localgroup administrators"; content: "|2F|add"; classtype: suspicious-command; reference: url,github.com/SigmaHQ/sigma/blob/master/rules/powershell; reference: url,wiki.quadrantsec.com/bin/view/Main/5005753; sid:5005753; rev:1;)

#--
alert any $HOME_NET any -> $EXTERNAL_NET any (msg:"[WINDOWS-POWERSHELL] DNSCAT VPN over DNS start up detected *CRITICAL AND CALL*"; event_id: 4104; program: *PowerShell*; content: "Start|2D|Dnscat2"; nocase; classtype: suspicious-command; reference: url,github.com/SigmaHQ/sigma/blob/master/rules/powershell; reference: url,github.com/iagox86/dnscat2; reference: url,wiki.quadrantsec.com/bin/view/Main/5005754; sid:5005754; rev:1;)
#--
alert any $HOME_NET any -> $EXTERNAL_NET any (msg:"[WINDOWS-POWERSHELL] Powershell Possible Downgrade Attempt"; event_id: 800,4104; program: *PowerShell*; content: "PowerShell |2D|Version"; pcre: "/PowerShell |2D|Version [0-6]/"; classtype: suspicious-command; reference: url,github.com/SigmaHQ/sigma/blob/master/rules/powershell; reference: url,wiki.quadrantsec.com/bin/view/Main/5005755; sid:5005755; rev:1;)
#--
alert any $HOME_NET any -> $EXTERNAL_NET any (msg:"[WINDOWS-POWERSHELL] PowerShell Auto Login Enabled, Possible Persistance Attempt [1/2]"; event_id: 4104; program: *PowerShell*; content: "CurrentVersion|5C|Winlogon"; content: "Set|2D|ItemProperty"; classtype: suspicious-command; reference: url,github.com/SigmaHQ/sigma/blob/master/rules/powershell; reference: url,wiki.quadrantsec.com/bin/view/Main/5005756; sid:5005756; rev:1;)
alert any $HOME_NET any -> $EXTERNAL_NET any (msg:"[WINDOWS-POWERSHELL] PowerShell Auto Login Enabled, Possible Persistance Attempt [2/2]"; event_id: 4104; program: *PowerShell*; content: "CurrentVersion|5C|Winlogon"; content: "New|2D|Item"; classtype: suspicious-command; reference: url,github.com/SigmaHQ/sigma/blob/master/rules/powershell; reference: url,wiki.quadrantsec.com/bin/view/Main/5005757; sid:5005757; rev:1;)

#Note: Host and Engine Mix Match is an IOC of a malicious program running.
#--
alert any $HOME_NET any -> $EXTERNAL_NET any (msg:"[WINDOWS-POWERSHELL] HostVersion and EngineVersion MixMatched [1/7]"; program: *PowerShell*; event_id: 400; content: "HostVersion|3D|1"; content:!"EngineVersion|3D| "; content:!"EngineVersion|3D|1"; content:!"ServerRemoteHost";nocase; content:!"Veeam";nocase; content:!"wsmprovhost|2e|exe";nocase; content:!"SolarWinds|2e|APM|2e|Probes";nocase; content:!"HostName|3d|ApmPSHost";nocase; content:!"MonitoringHost|2e|exe";nocase; content:!"HostName|3d|OpsMgr";nocase; content:!"mmc|2e|exe";nocase; content:!"LegacyVSTSPowerShellHost|2e|exe";nocase; content:!"MSExchangePowerShell";nocase; content:! "JAMSHost";nocase; content:!"Citrix";nocase; content:! "Ivanti|5c|Automation";nocase; content:! "PowerShellEditorServices|2e|VSCode";nocase; content:! "BigfinPSHostImplementation";nocase; content:!"dsac|2e|exe";nocase; content:!"ADMUX";nocase; content:!"WaPSHost";nocase; content:!"Ivanti Cloud Agent";nocase; content:!"N-able Technologies"; nocase; content:!"Microsoft BizTalk Server"; nocase; content:!"stealthbits"; nocase; pcre: "/EngineVersion=[2-7]/"; classtype: suspicious-traffic; threshold: type limit, track by_src, count 1, seconds 300; reference: url,github.com/SigmaHQ/sigma/blob/master/rules/powershell; reference: url, adsecurity.org/?p=2921; reference: url,wiki.quadrantsec.com/bin/view/Main/5005758; sid:5005758; rev:7;)

alert any $HOME_NET any -> $EXTERNAL_NET any (msg:"[WINDOWS-POWERSHELL] HostVersion and EngineVersion MixMatched [2/7]"; program: *PowerShell*; event_id: 400; content: "HostVersion|3D|2"; content:!"EngineVersion|3D| "; content:!"EngineVersion|3D|2"; content:!"ServerRemoteHost"; content:!"Veeam"; nocase; content:!"wsmprovhost|2e|exe"; nocase; content:!"SolarWinds|2e|APM|2e|Probes"; nocase; content:!"HostName|3d|ApmPSHost"; nocase; content:!"MonitoringHost|2e|exe"; nocase; content:!"HostName|3d|OpsMgr";nocase; content:!"mmc|2e|exe"; nocase; content:!"LegacyVSTSPowerShellHost|2e|exe"; nocase; content:!"MSExchangePowerShell";nocase; content:! "JAMSHost";nocase; content:!"Citrix";nocase; content:! "Ivanti|5c|Automation";nocase; content:! "PowerShellEditorServices|2e|VSCode";nocase; content:! "BigfinPSHostImplementation"; nocase; content:!"dsac|2e|exe";nocase; content:!"ADMUX"; nocase; content:!"WaPSHost"; nocase; content:!"Ivanti Cloud Agent"; nocase; content:!"N-able Technologies"; nocase; content:!"Microsoft BizTalk Server"; nocase; content:!"stealthbits"; nocase; pcre: "/EngineVersion=[1,3-7]/"; classtype: suspicious-traffic; threshold: type limit, track by_src, count 1, seconds 300; reference: url,github.com/SigmaHQ/sigma/blob/master/rules/powershell; reference: url, adsecurity.org/?p=2921; reference: url,wiki.quadrantsec.com/bin/view/Main/5005759; sid:5005759; rev:6;)


alert any $HOME_NET any -> $EXTERNAL_NET any (msg:"[WINDOWS-POWERSHELL] HostVersion and EngineVersion MixMatched [3/7]"; program: *PowerShell*; event_id: 400; content: "HostVersion|3D|3"; content:!"EngineVersion|3D| "; content:!"EngineVersion|3D|3"; content:!"ServerRemoteHost"; nocase; content:!"Veeam"; nocase; content:!"wsmprovhost|2e|exe"; nocase; content:!"SolarWinds|2e|APM|2e|Probes"; nocase; content:!"HostName|3d|ApmPSHost"; nocase; content:!"MonitoringHost|2e|exe"; nocase; content:!"HostName|3d|OpsMgr"; nocase; content:!"mmc|2e|exe"; nocase; content:!"LegacyVSTSPowerShellHost|2e|exe"; nocase; content:!"MSExchangePowerShell"; nocase; content:! "JAMSHost"; nocase; content:!"Citrix"; nocase; content:!"Ivanti|5c|Automation"; nocase; content:!"PowerShellEditorServices|2e|VSCode"; nocase; content:!"BigfinPSHostImplementation"; nocase; content:!"dsac|2e|exe"; nocase; content:!"ADMUX"; nocase; content:!"WaPSHost"; nocase; content:!"Ivanti Cloud Agent"; nocase; content:!"N-able Technologies"; nocase; content:!"Microsoft BizTalk Server"; nocase; content:!"stealthbits"; nocase; pcre: "/EngineVersion=[1,2,4-7]/"; classtype: suspicious-traffic; threshold: type limit, track by_src, count 1, seconds 300; reference: url,github.com/SigmaHQ/sigma/blob/master/rules/powershell; reference: url, adsecurity.org/?p=2921; reference: url,wiki.quadrantsec.com/bin/view/Main/5005760; sid:5005760; rev:6;)

alert any $HOME_NET any -> $EXTERNAL_NET any (msg:"[WINDOWS-POWERSHELL] HostVersion and EngineVersion MixMatched[4/7]"; program: *PowerShell*; event_id: 400; content: "HostVersion|3D|4"; content:!"EngineVersion|3D| "; content:!"EngineVersion|3D|4"; content:!"ServerRemoteHost"; nocase; content:!"Veeam"; nocase; content:!"wsmprovhost|2e|exe"; nocase; content:!"SolarWinds|2e|APM|2e|Probes"; nocase; content:!"HostName|3d|ApmPSHost"; nocase; content:!"MonitoringHost|2e|exe"; nocase; content:!"HostName|3d|OpsMgr"; nocase; content:!"mmc|2e|exe"; nocase; content:!"LegacyVSTSPowerShellHost|2e|exe"; nocase; content:!"MSExchangePowerShell"; nocase; content:! "JAMSHost"; nocase; content:!"Citrix"; nocase; content:!"Ivanti|5c|Automation"; nocase; content:!"PowerShellEditorServices|2e|VSCode"; nocase; content:! "BigfinPSHostImplementation"; nocase; content:!"dsac|2e|exe"; nocase; content:!"ADMUX"; nocase; content:!"WaPSHost"; nocase; content:!"Ivanti Cloud Agent"; nocase; content:!"N-able Technologies"; nocase; content:!"Microsoft BizTalk Server"; nocase; content:!"stealthbits"; nocase; pcre: "/EngineVersion=[1-3,5-7]/"; classtype: suspicious-traffic; threshold: type limit, track by_src, count 1, seconds 300; reference: url,github.com/SigmaHQ/sigma/blob/master/rules/powershell; reference: url, adsecurity.org/?p=2921; reference: url,wiki.quadrantsec.com/bin/view/Main/5005761; sid:5005761; rev:6;)

alert any $HOME_NET any -> $EXTERNAL_NET any (msg:"[WINDOWS-POWERSHELL] HostVersion and EngineVersion MixMatched[5/7]"; program: *PowerShell*; event_id: 400; content: "HostVersion|3D|5"; content:!"EngineVersion|3D| "; content:!"EngineVersion|3D|5"; content:!"ServerRemoteHost"; nocase; content:!"Veeam"; nocase; content:!"wsmprovhost|2e|exe"; nocase; content:!"SolarWinds|2e|APM|2e|Probes"; nocase; content:!"HostName|3d|ApmPSHost"; nocase; content:!"MonitoringHost|2e|exe"; nocase; content:!"HostName|3d|OpsMgr"; nocase; content:!"mmc|2e|exe"; nocase; content:!"LegacyVSTSPowerShellHost|2e|exe"; nocase; content:!"MSExchangePowerShell"; nocase; content:!"JAMSHost"; nocase; content:!"Citrix"; nocase; content:!"Ivanti|5c|Automation"; nocase; content:!"PowerShellEditorServices|2e|VSCode"; nocase; content:!"BigfinPSHostImplementation"; nocase; content:!"dsac|2e|exe"; nocase; content:!"ADMUX"; nocase; content:!"WaPSHost"; nocase; content:!"Ivanti Cloud Agent"; nocase; content:!"N-able Technologies"; nocase; content:!"Microsoft BizTalk Server"; nocase; content:!"stealthbits"; nocase; pcre: "/EngineVersion=[1-4,6,7]/"; classtype: suspicious-traffic; threshold: type limit, track by_src, count 1, seconds 300; reference: url,github.com/SigmaHQ/sigma/blob/master/rules/powershell; reference: url, adsecurity.org/?p=2921; reference: url,wiki.quadrantsec.com/bin/view/Main/5005762; sid:5005762; rev:6;)

alert any $HOME_NET any -> $EXTERNAL_NET any (msg:"[WINDOWS-POWERSHELL] HostVersion and EngineVersion MixMatched[6/7]"; program: *PowerShell*; event_id: 400; content: "HostVersion|3D|6"; content:!"EngineVersion|3D| "; content:!"EngineVersion|3D|6"; content:!"ServerRemoteHost"; nocase; content:!"Veeam"; nocase; content:!"wsmprovhost|2e|exe"; nocase; content:!"SolarWinds|2e|APM|2e|Probes"; nocase; content:!"HostName|3d|ApmPSHost"; nocase; content:!"MonitoringHost|2e|exe"; nocase; content:!"HostName|3d|OpsMgr"; nocase; content:!"mmc|2e|exe"; nocase; content:!"LegacyVSTSPowerShellHost|2e|exe"; nocase; content:!"MSExchangePowerShell"; nocase; content:! "JAMSHost"; nocase; content:!"Citrix"; nocase; content:!"Ivanti|5c|Automation"; nocase; content:!"PowerShellEditorServices|2e|VSCode"; nocase; content:!"BigfinPSHostImplementation"; nocase; content:!"dsac|2e|exe"; nocase; content:!"ADMUX"; nocase; content:!"WaPSHost"; nocase; content:!"Ivanti Cloud Agent"; nocase; content:!"N-able Technologies"; nocase; content:!"Microsoft BizTalk Server"; nocase; content:!"stealthbits"; nocase; pcre: "/EngineVersion=[1-5,7]/"; classtype: suspicious-traffic; threshold: type limit, track by_src, count 1, seconds 300; reference: url,github.com/SigmaHQ/sigma/blob/master/rules/powershell; reference: url,adsecurity.org/?p=2921; reference: url,wiki.quadrantsec.com/bin/view/Main/5005763; sid:5005763; rev:6;)


alert any $HOME_NET any -> $EXTERNAL_NET any (msg:"[WINDOWS-POWERSHELL] HostVersion and EngineVersion MixMatched[7/7]"; program: *PowerShell*; event_id: 400; content: "HostVersion|3D|7"; content:!"EngineVersion|3D| "; content:!"EngineVersion|3D|7"; content:!"ServerRemoteHost"; nocase; content:!"Veeam"; nocase; content:!"wsmprovhost|2e|exe"; nocase; content:!"SolarWinds|2e|APM|2e|Probes"; nocase; content:!"HostName|3d|ApmPSHost"; nocase; content:!"MonitoringHost|2e|exe"; nocase; content:!"HostName|3d|OpsMgr"; nocase; content:!"mmc|2e|exe"; nocase; content:!"LegacyVSTSPowerShellHost|2e|exe"; nocase; content:!"MSExchangePowerShell"; nocase; content:!"JAMSHost"; nocase; content:!"Citrix"; nocase; content:!"Ivanti|5c|Automation"; nocase; content:!"PowerShellEditorServices|2e|VSCode"; nocase; content:!"BigfinPSHostImplementation"; nocase; content:!"dsac|2e|exe"; nocase; content:!"ADMUX"; nocase; content:!"WaPSHost"; nocase; content:!"Ivanti Cloud Agent"; nocase; content:!"N-able Technologies"; nocase; content:!"Microsoft BizTalk Server"; nocase; content:!"stealthbits"; nocase; pcre: "/EngineVersion=[1-6]/"; classtype: suspicious-traffic; threshold: type limit, track by_src, count 1, seconds 300; reference: url,github.com/SigmaHQ/sigma/blob/master/rules/powershell; reference: url,adsecurity.org/?p=2921; reference: url,wiki.quadrantsec.com/bin/view/Main/5005764; sid:5005764; rev:7;)

# Writen by Chris Snyder for Hafnium, Modified by S.D. for generic sus activity in PS.

alert any $HOME_NET any -> $EXTERNAL_NET any (msg: "[WINDOWS-POWERSHELL] Suspicious Download using IEX"; program: *PowerShell*; content: "IEX |28|New|2d|Object Net|2e|WebClient|29 2e|downloadstring"; nocase; classtype: bad-unknown; reference: url,fireeye.com/blog/threat-research/2018/07/malicious-powershell-detection-via-machine-learning.html; reference: url,wiki.quadrantsec.com/bin/view/Main/5005765; sid:5005765; rev:3;)

# Good general signatures originally used to detect Kaseya / REvil randomware.

alert any $HOME_NET any -> $EXTERNAL_NET any (msg:"[WINDOWS-POWERSHELL] Powershell DisableIntrusionPreventionSystem detected"; program: *PowerShell*; content: "DisableIntrusionPreventionSystem"; content: !"|5f|cmdletization|5f|defaultValueIsPresent";nocase; content:!"ValidateNotNullOrEmpty";nocase; classtype: suspicious-command; reference: url,wiki.quadrantsec.com/bin/view/Main/5005914; sid:5005914; rev:1;)
#Update to 5005915 (v2) designed to prevent FP's when configuring Defender via master config file. Mod by CGoggins, pushed by sdrenning! 20220306
alert any $HOME_NET any -> $EXTERNAL_NET any (msg:"[WINDOWS-POWERSHELL] Powershell DisableScriptScanning detected"; program: *PowerShell*; content: "DisableScriptScanning"; content: !"this.AntiVirusSignatureVersion|20 3d 20|antiVirusSignatureVersion"; content: !"|5B|System|2E|IO|2E|File|5D 3A 3A|Open|28 27|C|3A 5C|ProgramData|5C|Microsoft|5C|Windows Defender Advanced Threat Protection|5C|DataCollection|0A|"; content: !"|5f|cmdletization|5f|defaultValueIsPresent";nocase; content:!"ValidateNotNullOrEmpty";nocase; classtype: suspicious-command; reference: url,wiki.quadrantsec.com/bin/view/Main/5005915; sid:5005915; rev:2;)

alert any $HOME_NET any -> $EXTERNAL_NET any (msg:"[WINDOWS-POWERSHELL] Powershell DisableRealtimeMonitoring detected"; program: *PowerShell*; content: "DisableRealtimeMonitoring"; content: !"|5f|cmdletization|5f|defaultValueIsPresent";nocase; content:!"ValidateNotNullOrEmpty";nocase; classtype: suspicious-command; reference: url,wiki.quadrantsec.com/bin/view/Main/5005916; sid:5005916; rev:1;)

alert any $HOME_NET any -> $EXTERNAL_NET any (msg:"[WINDOWS-POWERSHELL] Powershell MAPSReporting Disabled detected"; program: *PowerShell*; content: "MAPSReporting Disabled"; content: !"|5f|cmdletization|5f|defaultValueIsPresent";nocase; content:!"ValidateNotNullOrEmpty";nocase; classtype: suspicious-command; reference: url,wiki.quadrantsec.com/bin/view/Main/5005917; sid:5005917; rev:1;)

# Rules written to detect the export of Secret Key via PowerShell Command: General sus activity in PS. By S.Drenning off of IOCs for Golden Saml Attack

alert any $HOME_NET any -> $EXTERNAL_NET any (msg:"[WINDOWS-POWERSHELL] Powershell Command to Export Secret Key Detected [1/2]"; event_id: 4103,4104; program: *PowerShell*; content: "Export|2d|PfxCertificate";nocase; classtype: suspicious-command; reference: url,github.com/SigmaHQ/sigma/blob/master/rules/powershell; reference: url,sygnia.co/golden-saml-advisory; sid:5005954; rev:1;)

alert any $HOME_NET any -> $EXTERNAL_NET any (msg:"[WINDOWS-POWERSHELL] Powershell Command to Export Secret Key Detected [2/2]"; event_id: 4103,4104; program: *PowerShell*; content: "certutil |2d|exportPFX";nocase; classtype: suspicious-command; reference: url,github.com/SigmaHQ/sigma/blob/master/rules/powershell; reference: url,sygnia.co/golden-saml-advisory; sid:5005955; rev:1;)

#IOC's for 5005984-5005986 developed from Malware in the wild. sdrenning 20220306
alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-POWERSHELL] Suspicious Pingtest"; program: *PowerShell*; content:"|24|ping |3d| test|2d|connection";nocase; content:"|2d|comp"; distance: 1; within: 25; content:"|2d|count"; distance:1; within: 25; content:"|2d|Quiet";nocase; distance:1; within:25; classtype: suspicious-command; sid:5005984; rev:2;)

alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-POWERSHELL] Obfuscated New-Object Command (1/2)"; program: *PowerShell*; content:"RightToLeft";nocase; content:"|27|eW.teN ct|27 20 2B 20 27|ejbO|2d|weN|28 27|";classtype: suspicious-command; sid:5005985; rev:2;)

alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-POWERSHELL] Obfuscated New-Object Command (2/2)"; program: *PowerShell*; content:"RightToLeft";nocase; content:"tneilCbeW.teN ctejbO|2d|weN";classtype: suspicious-command; sid:5005986; rev:2;)

#5006106 Less specific rule to detect Malicious Download using IEX to account for differences in spacing/ Augment Existing rule 5005765. .5006107 Rule to detect powershell loging of AV blocking malicious scripts. sdrenning! 20220507
alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-POWERSHELL] Suspicious Download using IEX"; program: *PowerShell*; content: "IEX"; nocase; content: "New|2d|Object"; distance: 1; nocase; content: "Net|2e|WebClient|29 2e|downloadstring"; nocase; distance: 1; threshold: type suppress, track by_src, count 1, seconds 3600; classtype: suspicious-command; reference: url,fireeye.com/blog/threat-research/2018/07/malicious-powershell-detection-via-machine-learning.html; reference: url,wiki.quadrantsec.com/bin/view/Main/5005765; sid:5006106; rev:1;)

alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-POWERSHELL] Anti-virus Has Blocked Malicious Content"; program: *PowerShell*; content: "malicious content"; nocase; content: "blocked"; nocase; distance:1; content: "antivirus software"; nocase; distance: 1; threshold: type suppress, track by_src, count 1, seconds 3600;  classtype: bad-unknown; sid:5006107; rev:1;)

alert any $EXTERNAL_NET any -> any any (msg: "[WINDOWS-POWERSHELL] MSDT PCWDiagnostic Call to Powershell Detected (CVE-2022-30190)"; content: "ms-msd|3a 2f|id"; nocase; content: "PCWDiagnostic"; nocase; meta_content: "%sagan%",Invoke,IT_RebrowseForFile,IT_LaunchMethod,IT_SelectProgram,IEX; meta_nocase; classtype: suspicious-command; reference: url,www.huntress.com/blog/microsoft-office-remote-code-execution-follina-msdt-bug; sid:5006520; rev: 1;)


